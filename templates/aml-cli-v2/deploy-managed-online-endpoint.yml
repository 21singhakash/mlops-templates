parameters:
- name: job_type
  type: string

steps:
  - task: AzureCLI@2
    displayName: Create and deploy managed online endpoint 
    inputs: 
      azureSubscription: $(ado_service_connection_aml_ws)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e
        az ml online-endpoint create --name $(moe_endpoint_name)
        az ml online-deployment create --name $(moe_deployment_name) --endpoint $(moe_endpoint_name) -f $(moe_deployment_file)
    condition: and(succeeded(), eq('${{ parameters.job_type }}', 'create-deployment'))
  - task: AzureCLI@2
    displayName: Update managed online endpoint deployment
    inputs: 
      azureSubscription: $(ado_service_connection_aml_ws)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e
        az ml online-deployment update--name $(moe_deployment_name) --endpoint $(moe_endpoint_name) -f $(moe_deployment_file)
    condition: and(succeeded(), eq('${{ parameters.job_type }}', 'update-deployment'))
  - task: AzureCLI@2
    displayName: Update traffic allocation
    inputs:
      azureSubscription: $(ado_service_connection_aml_ws)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e
        az ml online-endpoint update --name $(moe_endpoint_name) --traffic "$(traffic_allocation)"
    condition: and(succeeded(), eq('${{ parameters.job_type }}', 'traffic_allocation'))